# 🎯 階層式數量分配系統指南

## 📋 功能概述

階層式數量分配系統是一個強大的項目管理工具，允許您在專案的不同層級（工作包→子工作包→任務）之間智能分配和管理數量。

### 核心特色

- **🔄 階層式分配**：工作包→子工作包→任務的三層數量分配
- **🧠 智能分配策略**：平均分配、比例分配、手動設置、剩餘分配
- **📊 實時進度追蹤**：自動計算各層級完成進度
- **✅ 數據驗證**：確保分配數量與完成數量的一致性
- **🎨 直觀界面**：右鍵菜單操作，一鍵觸發分配對話框

## 🚀 快速開始

### 1. 訪問數量管理功能

1. 進入專案頁面
2. 選擇一個專案
3. 點擊「**數量管理**」選項卡
4. 您將看到：
   - 專案概覽統計
   - 虛擬化項目樹
   - 分配狀態概覽

### 2. 基本操作流程

**Step 1: 工作包數量設置**
```
工作包 (0/0) → 右鍵 → 分配數量 → 設置總數量 → 分配到子工作包
```

**Step 2: 子工作包數量設置**
```
子工作包 (0/0) → 右鍵 → 分配數量 → 設置總數量 → 分配到任務
```

**Step 3: 任務執行**
```
任務會根據分配的數量自動計算進度百分比
```

## 📋 詳細操作步驟

### 🎯 分配工作包數量到子工作包

1. **打開分配對話框**
   - 在專案樹中找到目標工作包
   - 右鍵點擊工作包
   - 選擇「分配數量」

2. **設置總數量**
   - 在「總數量」欄位輸入工作包的總數量
   - 例如：1000

3. **選擇分配策略**
   - **平均分配**：將總數量平均分配給所有子工作包
   - **比例分配**：按現有數量比例重新分配
   - **剩餘分配**：保持現有分配，剩餘數量分配給第一個子工作包
   - **手動設置**：手動為每個子工作包設置數量

4. **調整具體分配**
   - 在分配詳情區域手動調整每個子工作包的數量
   - 系統會實時顯示剩餘數量和驗證錯誤

5. **確認分配**
   - 檢查統計信息和驗證結果
   - 點擊「確認分配」

### 🎯 分配子工作包數量到任務

操作流程與工作包類似：

1. 右鍵點擊子工作包
2. 選擇「分配數量」
3. 設置子工作包總數量
4. 選擇分配策略並調整
5. 確認分配到任務

## 🧠 分配策略詳解

### 1. 平均分配 (Equal Distribution)
```
總數量：1000
子項目：3個
結果：334, 333, 333 (自動處理餘數)
```

### 2. 比例分配 (Proportional Distribution)
```
原分配：200, 300, 500
新總量：1500
結果：300, 450, 750 (按原比例 2:3:5)
```

### 3. 剩餘分配 (Remaining Distribution)
```
現有分配：200, 300, 0
新總量：1000
結果：700, 300, 0 (剩餘500分配給第一個)
```

### 4. 手動設置 (Manual Distribution)
```
完全手動控制每個子項目的分配數量
系統提供實時驗證和統計
```

## 📊 進度計算邏輯

### 自動進度重算
當您分配數量後，系統會自動：

1. **更新數量**：設置每個層級的 total 值
2. **重新計算進度**：根據 completed/total 計算百分比
3. **向上聚合**：子級進度自動聚合到父級
4. **更新界面**：實時反映在樹狀結構和進度條中

### 進度聚合規則
```
任務進度 = completed / total * 100%
子工作包進度 = Σ(任務completed) / Σ(任務total) * 100%
工作包進度 = Σ(子工作包completed) / Σ(子工作包total) * 100%
專案進度 = Σ(工作包completed) / Σ(工作包total) * 100%
```

## ✅ 數據驗證規則

### 分配驗證
- ✅ 總數量必須大於 0
- ✅ 分配總數必須等於設定總數
- ✅ 分配數量不能小於已完成數量
- ✅ 所有子項目都必須有分配數量

### 錯誤處理
系統會顯示詳細的驗證錯誤信息：
```
❌ 總數量必須大於 0
❌ 分配總數 (800) 與設定總數 (1000) 不一致
❌ 子工作包A: 分配數量不能小於已完成數量
```

## 🎨 界面元素說明

### 📊 統計面板
- **已分配**：當前所有子項目的分配總數
- **已完成**：當前所有子項目的完成總數
- **剩餘**：尚未分配的數量
- **子項目**：需要分配的子項目數量

### 🎛️ 快速操作按鈕
- **平均分配**：一鍵平均分配
- **比例分配**：按現有比例重新分配
- **重置分配**：清空所有分配數量

### 📋 分配詳情表
- 顯示每個子項目的名稱、分配數量、完成數量
- 支援手動調整分配數量
- 實時顯示進度條和完成百分比

## 💡 最佳實踐

### 1. 分配策略選擇
- **新專案**：使用平均分配快速開始
- **已有數據**：使用比例分配保持現有平衡
- **特殊需求**：使用手動設置精確控制

### 2. 數量設置建議
- **工作包**：設置較大的基數（如 1000、10000）
- **子工作包**：根據實際工作量按比例分配
- **任務**：設置便於追蹤的小單位（如 10、100）

### 3. 進度管理
- 定期檢查分配狀態概覽
- 關注「不足」標記的項目
- 及時調整不合理的分配

### 4. 團隊協作
- 在分配前與團隊討論分配策略
- 使用分配對話框的註解功能記錄決策
- 定期審查和調整分配方案

## 🔧 技術特色

### 高性能虛擬化
- 支援大規模專案（1000+ 項目）
- 虛擬化樹狀結構，流暢操作
- 智能展開/收起，優化載入速度

### 實時計算
- 即時數據驗證和進度計算
- 無需刷新，立即反映變更
- 智能緩存，提升響應速度

### 權限控制
- 基於角色的數量分配權限
- 細粒度操作權限控制
- 安全的數據修改機制

## 🐛 常見問題

### Q: 為什麼分配後進度沒有變化？
**A**: 確保已完成數量（completed）小於等於分配數量（total）。進度 = completed / total。

### Q: 可以修改已分配的數量嗎？
**A**: 可以。重新打開分配對話框，調整數量後重新分配即可。

### Q: 如何重置所有分配？
**A**: 在分配對話框中點擊「重置分配」按鈕，或將總數量設為 0。

### Q: 分配策略的優先順序是什麼？
**A**: 手動調整 > 選擇的分配策略 > 系統默認平均分配。

### Q: 為什麼某些項目無法分配數量？
**A**: 檢查用戶權限，只有工作包和子工作包支援數量分配，任務級別不支援再次分配。

## 📝 更新日誌

### v1.0.0 (2024-01-XX)
- ✅ 基礎數量分配功能
- ✅ 四種分配策略實現
- ✅ 實時進度計算
- ✅ 數據驗證機制
- ✅ 虛擬化樹狀界面

### 計劃功能
- 🔄 批量分配操作
- 📊 分配歷史記錄
- 📈 進度預測分析
- 🔔 分配完成通知

---

**💡 提示**：此系統旨在簡化專案數量管理，提高團隊協作效率。如有任何問題或建議，請隨時聯繫開發團隊。 